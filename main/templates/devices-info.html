{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información del dispositivo - EnergySafe</title>
    <link rel='stylesheet' href="{% static 'css/devices.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/radar.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
    <style>
        .data-refresh-indicator {
            position: fixed;
            top: 95px;
            right: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .data-refresh-indicator.active {
            opacity: 1;
        }
        
        .data-refresh-indicator::after {
            content: "";
            width: 18px;
            height: 18px;
            border: 2px solid rgba(28, 66, 104, 0.3);
            border-top: 2px solid #1C4268;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .data-updated-time {
            position: fixed;
            top: 95px;
            right: 50px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #333;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
        }
    </style>
</head>
<body data-appliance-id="{{ appliance.id }}">
    <div class="header-container">
        <div class="logo">
            <a href="{% url 'home' %}">
                <img src="https://i.imgur.com/M8s3mYZ.png" alt="Logo de EnergySafe">
            </a>
        </div>
        <div class="optios">
            <a href="/home"><h2>Inicio</h2></a>
            <a href="/download"><h2>Descargar</h2></a>
            <a href="/devices"><h2>Dispositivos</h2></a>
            <a href="/products"><h2>Productos</h2></a>
            <a href="/about-us"><h2>Acerca de nosotros</h2></a>
            {% if user.is_authenticated %}
                <a href="{% url 'logout' %}" id="Login-Register"><h2>Cerrar sesión</h2></a>
            {% else %}
                <a href="{% url 'login' %}" id="Login-Register"><h2>Login/Register</h2></a>
            {% endif %}
        </div>
    </div>

    <!-- Data refresh indicator -->
    <div class="data-refresh-indicator" id="refresh-indicator"></div>
    <div class="data-updated-time" id="last-update-time">Última actualización: Cargando...</div>
    
    <div class="container">
        <div class="first-part">
            <img src="https://i.imgur.com/Gc9kzyb.png" alt="">
            <div class="voltaje">
                <hr>
                <h1 id="voltaje-text">VOLTAJE</h1>
                <div class="circle-v">
                    <img id="circle-v" src="https://i.imgur.com/BR1kvFH.png" alt="">
                    <img id="flash-v" src="https://i.imgur.com/dKBjb76.png" alt="">
                </div>
                <div class="information-v">
                    <h1 id="voltaje-v">{{ latest_consumption.voltaje|floatformat:0 }}V</h1>
                    <h3 id="voltaje-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                    <div class="porcentaje-v">
                        <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                        <h2 id="voltaje-porcentaje">
                            {% if voltage_stats.avg > 0 %}
                                {{ voltage_stats.avg|floatformat:0 }}% promedio
                            {% else %}
                                2% desde ayer
                            {% endif %}
                        </h2>
                    </div>
                </div>
            </div>
            <div class="kwh">
                <hr>
                <h3 id="kwh-text">kWh CONSUMIDOS</h3>
                <div class="kwh-text"></div>
                <div class="kwh-dashboard">
                    <div class="dashboard">
                        <div class="kwh-info">
                            <h1 id="kw">{{ latest_consumption.consumo|floatformat:1 }} <span>kWh</span></h1>
                        </div>
                        <div class="chart" id="consumption-chart">
                            <div class="bar-container">
                                <div class="bar" id="bar-lun"></div>
                                <div class="day">Lun</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-mar"></div>
                                <div class="day">Mar</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-mir"></div>
                                <div class="day">Mir</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-jue"></div>
                                <div class="day">Jue</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-vie"></div>
                                <div class="day">Vie</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-sab"></div>
                                <div class="day">Sab</div>
                            </div>
                            <div class="bar-container">
                                <div class="bar" id="bar-dom"></div>
                                <div class="day">Dom</div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard2">
                        <div class="grafico-circular-container">
                            <div class="grafico-circular-wrapper">
                                <div class="grafico-container">
                                    <canvas id="grafico-circular" width="197" height="197"></canvas>
                                    <div class="tooltip" id="tooltip"></div>
                                </div>
                                <div class="leyenda-container" id="leyenda">
                                    <!-- La leyenda se generará dinámicamente con JavaScript -->
                                </div>
                            </div>
                        </div>
                        <h1>{{ latest_consumption.consumo|floatformat:1 }}kWh</h1>
                        <h3>{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="second-part">
            <div class="amperios">
                <hr>
                <h1 id="amperios-text">Amperios</h1>
                <div class="amperios-info">
                    <div class="chart-container">
                        <!-- Fixed gauge div without using division filter -->
                        <div id="chartdiv1" class="chartdiv" data-value="50"></div>
                    </div>
                    <div class="information-a">
                        <h1 id="amperios-a">{{ latest_consumption.corriente|floatformat:1 }} <span>A</span></h1>
                        <h3 id="amperios-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                        <div class="porcentaje-a">
                            <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                            <h2 id="amperios-porcentaje">
                                {% if current_stats.avg > 0 %}
                                    {{ current_stats.avg|floatformat:0 }}% promedio
                                {% else %}
                                    2% desde ayer
                                {% endif %}
                            </h2>
                        </div>
                    </div>
                    <div class="circle-a">
                        <img id="circle-a" src="https://i.imgur.com/BR1kvFH.png" alt="">
                        <img id="flash-a" src="https://i.imgur.com/EeXnkJx.png" alt="">
                    </div>
                </div>
            </div>

            <div class="corriente">
                <hr>
                <h1 id="amperios-text">Corriente</h1>
                <div class="amperios-info">
                    <div class="circle-a">
                        <img id="circle-a" src="https://i.imgur.com/BR1kvFH.png" alt="">
                        <img id="flash-a" src="https://i.imgur.com/J1obQa6.png" alt="">
                    </div>
                    <div class="chart-container">
                        <!-- Fixed gauge div without using division filter -->
                        <div id="chartdiv2" class="chartdiv" data-value="50"></div>
                    </div>
                    <div class="information-a">
                        <h1 id="amperios-a">{{ latest_consumption.potencia|floatformat:0 }} <span>W</span></h1>
                        <h3 id="amperios-date">{{ latest_consumption.fecha|date:"F j Y" }}</h3>
                        <div class="porcentaje-a">
                            <img src="https://i.imgur.com/NHR1Q8A.png" alt="">
                            <h2 id="amperios-porcentaje">
                                {% if current_stats.avg > 0 %}
                                    {{ current_stats.avg|floatformat:0 }}% promedio
                                {% else %}
                                    2% desde ayer
                                {% endif %}
                            </h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dispositivo-monitor-wrapper" id="monitorizacion-dispositivos">
            <div class="info-box">
                <table id="dispositivo-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Voltaje</th>
                            <th>Corriente</th>
                            <th>Potencia</th>
                            <th>Consumo</th>
                            <th>Frecuencia</th>
                        </tr>
                    </thead>
                    <div class="table-info">
                        <tbody>
                            {% for item in consumption_history %}
                            <tr>
                                <td>#{{ forloop.counter }}</td>
                                <td>
                                    {% if item.fecha|date %}
                                        {{ item.fecha|date:"Y/m/d" }}<br>{{ item.fecha|time:"H:i:s" }}
                                    {% else %}
                                        {{ item.fecha }}
                                    {% endif %}
                                </td>
                                <td>{{ item.voltaje|floatformat:0 }} v</td>
                                <td>{{ item.corriente|floatformat:1 }} A</td>
                                <td>{{ item.potencia|floatformat:0 }} w</td>
                                <td>{{ item.consumo|floatformat:1 }} kWh</td>
                                <td>
                                    {% if item.frecuencia %}
                                        {{ item.frecuencia|floatformat:0 }}Hz
                                    {% else %}
                                        60Hz
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td>#1</td>
                                <td>{{ latest_consumption.fecha|date:"Y/m/d" }}<br>{{ latest_consumption.fecha|time:"H:i:s" }}</td>
                                <td>{{ latest_consumption.voltaje|floatformat:0 }} v</td>
                                <td>{{ latest_consumption.corriente|floatformat:1 }} A</td>
                                <td>{{ latest_consumption.potencia|floatformat:0 }} w</td>
                                <td>{{ latest_consumption.consumo|floatformat:1 }} kWh</td>
                                <td>60Hz</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
        
                <h2 id="alert-text">Historial de Alertas</h2>
                
                <div class="info-box">
                    <div class="alert-header"><h2>Anomalías detectadas</h2></div>
                    <div id="alertas-container">
                        {% for alert in alerts %}
                        <div class="alert-item" data-alert-id="{{ alert.id }}">
                            <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                            <div id="alert-alarm">
                                {% if alert.mensaje %}
                                    {{ alert.mensaje }}
                                {% else %}
                                    {{ alert }}
                                {% endif %}
                            </div>
                            <div class="close-btn">✕</div>
                        </div>
                        {% empty %}
                        <div class="alert-item" id="no-alerts-message">
                            <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                            <div id="alert-alarm">No hay alertas activas en este momento.</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Component para EnergySafe -->
<footer class="energysafe-footer">
    <div class="footer-top">
      <div class="footer-container">
        <div class="footer-row">
          <!-- Logo y descripción -->
          <div class="footer-column footer-about">
            <div class="footer-logo">
              <img src="https://i.imgur.com/2EhmVK6.png" alt="EnergySafe Logo">
            </div>
            <p class="footer-description">
              Soluciones inteligentes para el monitoreo y optimización del consumo energético en tu hogar y negocio.
            </p>
            <div class="footer-badges">
              <span class="eco-badge">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.18 6.68c1.22.57 2.28 1.43 3.15 2.5"></path><path d="M9.04 19.8c-3.18-.32-5.88-2.27-7.24-5.08"></path><path d="M9.04 4.2c-3.18.32-5.88 2.27-7.24 5.08"></path><path d="M18.18 17.32c1.22-.57 2.28-1.43 3.15-2.5"></path><path d="m5.97 15.32-.25 2.66c-.04.44.3.84.74.92l2.59.48c2.89.53 5.84-.83 7.25-3.39l.72-1.33c.23-.41.19-.92-.08-1.28l-1.59-2.11c-1.95-2.62-5.47-3.64-8.4-2.45l-2.36.96c-.41.17-.64.6-.57 1.04l.25 2.65"></path><path d="m15.91 13.04 1.58-1.98a.8.8 0 0 0-.02-1.05l-1.32-1.44"></path></svg>
                Eco-friendly
              </span>
              <span class="secure-badge">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"></path><path d="m9 12 2 2 4-4"></path></svg>
                Seguridad garantizada
              </span>
            </div>
          </div>
  
          <!-- Enlaces rápidos -->
          <div class="footer-column">
            <h3 class="footer-title">EnergySafe</h3>
            <ul class="footer-links">
              <li><a href="{% url 'home' %}">Inicio</a></li>
              <li><a href="{% url 'productos' %}">Nuestros productos</a></li>
              <li><a href="{% url 'download' %}">Aplicación móvil</a></li>
              <li><a href="/blog">Blog y recursos</a></li>
              <li><a href="{% url 'aboutus' %}">Nuestra empresa</a></li>
              <li><a href="/soporte">Centro de ayuda</a></li>
            </ul>
          </div>
  
          <!-- Productos -->
          <div class="footer-column">
            <h3 class="footer-title">Productos</h3>
            <ul class="footer-links">
              <li><a href="/products/energysafe-standard">EnergySafe Standard</a></li>
              <li><a href="/products/energysafe-pro">EnergySafe Pro</a></li>
              <li><a href="/products/accesorios">Accesorios</a></li>
              <li><a href="/garantia">Garantía y soporte</a></li>
              <li><a href="/descargas">Software y actualizaciones</a></li>
              <li><a href="/donde-comprar">Dónde comprar</a></li>
            </ul>
          </div>
  
          <!-- Soluciones -->
          <div class="footer-column">
            <h3 class="footer-title">Soluciones</h3>
            <ul class="footer-links">
              <li><a href="/para-hogares">Para hogares</a></li>
              <li><a href="/para-negocios">Para negocios</a></li>
              <li><a href="/integraciones">Integraciones</a></li>
              <li><a href="/calculadora">Calculadora de ahorro</a></li>
              <li><a href="/testimonios">Casos de éxito</a></li>
              <li><a href="/recursos">Recursos educativos</a></li>
            </ul>
          </div>
  
          <!-- Contacto y newsletter -->
          <div class="footer-column footer-contact">
            <h3 class="footer-title">Contáctanos</h3>
            <ul class="footer-contact-info">
              <li>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                <span>+52 (614) 127-4780</span>
              </li>
              <li>
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                <span>contacto@energysafe.com</span>
              </li>

            </ul>
            
            <div class="footer-newsletter">
              <h4>Mantente informado</h4>
              <p>Suscríbete a nuestro boletín para recibir consejos y novedades</p>
              <form action="/suscribir" method="post" class="newsletter-form">
                {% csrf_token %}
                <input type="email" name="email" placeholder="Tu correo electrónico" required>
                <button type="submit" class="subscribe-btn">Suscribirme</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Apps y social -->
    <div class="footer-middle">
      <div class="footer-container">
        <div class="footer-row">
          <div class="footer-app-downloads">
            <h3>Descarga nuestra aplicación</h3>
            <div class="app-buttons">
              <a href="https://play.google.com/store" class="app-button" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3.609 1.814L13.792 12l-10.183 10.186c-2.05-.618-3.283-2.645-3.283-4.735V6.549c0-2.09 1.232-4.117 3.283-4.735zm13.4 2.766l-2.974 2.974L5.008 2.483l.2-.129C7.009 1.162 9.865 2.283 11.95 4.099l5.059.481zM1.654 1.916C1.798 1.843 1.946 1.778 2 1.724l17.336 8.708L16.626 12l-2.677 2.677-12.262-12.79c-.068.033-.016-.006-.033.029zm15.42 15.446c-2.443 2.156-5.015 2.96-6.945 2.354l-.199-.08 8.126-8.125 2.777 2.777-3.759 3.074z"/></svg>
                <span>Google Play</span>
              </a>
              <a href="https://www.apple.com/app-store/" class="app-button" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M16.462 8.624C16.928 8.065 17.205 7.278 17.116 6.5c-.771.062-1.729.421-2.284 1.001-.5.521-.96 1.365-.85 2.165.867.071 1.738-.357 2.48-1.042zm1.128 3.418c-1.721-.103-3.182 1.005-4.002 1.005-.82 0-2.064-.957-3.407-.932-1.749.026-3.371 1.059-4.256 2.677-1.838 3.157-.48 7.802 1.283 10.357.876 1.263 1.897 2.648 3.243 2.598 1.295-.05 1.79-.822 3.366-.822 1.576 0 2.048.822 3.429.797 1.43-.027 2.327-1.266 3.195-2.532.985-1.423 1.391-2.79 1.412-2.858-.032-.012-2.681-1.006-2.708-4.062-.024-2.542 2.061-3.762 2.144-3.822-1.191-1.731-3.02-1.911-3.679-1.949-1.711-.116-3.146.965-3.978.965-.831 0-2.078-.919-3.42-.919-1.736.004-3.37 1.064-4.254 2.7-1.799 3.142-.465 7.765 1.289 10.314.863 1.244 1.897 2.647 3.245 2.598 1.284-.05 1.784-.828 3.354-.828 1.568 0 2.028.828 3.416.803 1.418-.025 2.334-1.277 3.184-2.535.968-1.403 1.375-2.778 1.401-2.85-.035-.01-2.709-1.041-2.709-4.062 0-2.341 1.881-3.594 1.997-3.647z"/></svg>
                <span>App Store</span>
              </a>
            </div>
          </div>
          
          <div class="social-icons">
            <a href="https://facebook.com/" target="_blank" class="social-icon facebook">
              <img src="https://www.svgrepo.com/show/452196/facebook-1.svg" alt="Facebook" width="20" height="20">
            </a>
            <a href="https://www.instagram.com/" target="_blank" class="social-icon instagram">
              <img src="https://www.svgrepo.com/show/452229/instagram-1.svg" alt="Instagram" width="20" height="20">
            </a>
          </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Certificaciones y premios -->
    <div class="footer-awards">
      <div class="footer-container">
        <div class="awards-row">
          <div class="award">
            <img src="{% static 'images/icons/iso-certified.svg' %}" alt="ISO Certified">
            <span>ISO 9001:2015</span>
          </div>
          <div class="award">
            <img src="{% static 'images/icons/energy-star.svg' %}" alt="Energy Star">
            <span>Energy Star Partner</span>
          </div>
          <div class="award">
            <img src="{% static 'images/icons/secure-payment.svg' %}" alt="Secure Payment">
            <span>Pagos Seguros</span>
          </div>
          <div class="award">
            <img src="{% static 'images/icons/eco-friendly.svg' %}" alt="Eco Friendly">
            <span>Eco Friendly</span>
          </div>
          <div class="award">
            <img src="{% static 'images/icons/innovative-tech.svg' %}" alt="Innovative Technology">
            <span>Tecnología Innovadora 2024</span>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Bottom footer -->
    <div class="footer-bottom">
      <div class="footer-container">
        <div class="footer-row">
          <div class="copyright">
            &copy; 2025 EnergySafe. Todos los derechos reservados | <a href="/terminos-y-condiciones">Términos y Condiciones</a> | <a href="/aviso-de-privacidad">Aviso de Privacidad</a>
          </div>
          <div class="payment-methods">
            <span>Métodos de pago</span>
            <img src="{% static 'images/icons/visa.svg' %}" alt="Visa">
            <img src="{% static 'images/icons/mastercard.svg' %}" alt="Mastercard">
            <img src="{% static 'images/icons/amex.svg' %}" alt="American Express">
            <img src="{% static 'images/icons/paypal.svg' %}" alt="PayPal">
            <img src="{% static 'images/icons/mercadopago.svg' %}" alt="Mercado Pago">
          </div>
        </div>
      </div>
    </div>
  </footer>

    <script>
        // Calculate initial gauge values from data
        function calculateGaugeValues() {
            // For voltage gauge
            const voltageElement = document.getElementById('chartdiv1');
            const voltageValue = {{ latest_consumption.voltaje|default:0 }};
            const voltageMax = {{ voltage_stats.max|default:120 }};
            
            // Calculate percentage (0-100)
            let voltagePercentage = 0;
            if (voltageMax > 0) {
                voltagePercentage = Math.min(Math.max((voltageValue / voltageMax) * 100, 0), 100);
            } else {
                voltagePercentage = Math.min(Math.max((voltageValue / 120) * 100, 0), 100); // Default max
            }
            
            // Set the data-value attribute
            voltageElement.setAttribute('data-value', voltagePercentage.toFixed(0));
            
            // For current gauge
            const currentElement = document.getElementById('chartdiv2');
            const currentValue = {{ latest_consumption.corriente|default:0 }};
            const currentMax = {{ current_stats.max|default:5 }};
            
            // Calculate percentage (0-100)
            let currentPercentage = 0;
            if (currentMax > 0) {
                currentPercentage = Math.min(Math.max((currentValue / currentMax) * 100, 0), 100);
            } else {
                currentPercentage = Math.min(Math.max((currentValue / 5) * 100, 0), 100); // Default max
            }
            
            // Set the data-value attribute
            currentElement.setAttribute('data-value', currentPercentage.toFixed(0));
        }

        // Valores de consumo diario desde el servidor
        const defaultValues = {{ daily_consumption|safe }};
        
        // Función para actualizar el gráfico con los valores dados
        function updateChart(values) {
            const maxValue = Math.max(...Object.values(values)) * 1.2; // 20% más que el máximo valor
            const maxHeight = 150; // Altura máxima en píxeles
            
            Object.keys(values).forEach(day => {
                const value = values[day];
                const bar = document.getElementById(`bar-${day}`);
                
                if (bar) {
                    // Calcular altura relativa (mínimo 10px para que se vea incluso si es > 0)
                    const height = value === 0 ? 0 : Math.max(10, (value / maxValue) * maxHeight);
                    
                    bar.style.height = `${height}px`;
                    bar.textContent = value.toFixed(1);
                }
            });
        }
        
        // Inicializar el gráfico con valores desde el servidor
        window.onload = function() {
            updateChart(defaultValues);
            calculateGaugeValues();
        };
    </script>

    <script>
        window.onscroll = function() {
            var header = document.querySelector('.header-container');
            if (window.scrollY > 50) { // Cuando el scroll pase de 50px
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Cerrar alertas
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.alert-item').remove();
                });
            });
        });
    </script>

    <script>
        // Datos para el gráfico circular desde el servidor
        const datos = {{ pie_chart_data|safe }};

        // Obtener el contexto del canvas
        const canvas = document.getElementById('grafico-circular');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');
        const leyendaContainer = document.getElementById('leyenda');
        
        // Establecer el tamaño del canvas
        canvas.width = 197;
        canvas.height = 197;
        
        // Calcular el total
        function calcularTotal() {
            return datos.reduce((total, item) => total + item.valor, 0);
        }

        // Dibujar el gráfico circular con agujero interior blanco
        function dibujarGrafico() {
            // Limpiar el canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const total = calcularTotal();
            const radio = (Math.min(canvas.width, canvas.height) / 2) - 10;
            const centroX = canvas.width / 2;
            const centroY = canvas.height / 2;

            let anguloInicial = -Math.PI / 2; // Comenzar desde arriba

            // Dibujar cada segmento
            datos.forEach(item => {
                if (item.valor <= 0) return; // Omitir elementos con valor 0

                const angulo = (item.valor / total) * (Math.PI * 2);
                const anguloFinal = anguloInicial + angulo;

                // Dibujar segmento
                ctx.beginPath();
                ctx.moveTo(centroX, centroY);
                ctx.arc(centroX, centroY, radio, anguloInicial, anguloFinal);
                ctx.closePath();

                ctx.fillStyle = item.color;
                ctx.fill();

                // Actualizar ángulo inicial para el siguiente segmento
                anguloInicial = anguloFinal;
            });

            // Dibujar el círculo blanco en el centro para simular el agujero
            ctx.beginPath();
            ctx.arc(centroX, centroY, radio / 1.5, 0, Math.PI * 2, false); // Radio más pequeño
            ctx.fillStyle = "white"; // Color blanco
            ctx.fill();
        }

        // Crear la leyenda
        function crearLeyenda() {
            leyendaContainer.innerHTML = '';
            
            datos.forEach((item, index) => {
                if (item.valor <= 0) return; // No mostrar elementos con valor 0
                
                const leyendaItem = document.createElement('div');
                leyendaItem.className = 'leyenda-item';
                leyendaItem.dataset.index = index;
                
                const leyendaColor = document.createElement('div');
                leyendaColor.className = 'leyenda-color';
                leyendaColor.style.backgroundColor = item.color;
                
                const leyendaTexto = document.createElement('div');
                leyendaTexto.className = 'leyenda-texto';
                leyendaTexto.textContent = item.nombre;
                
                leyendaItem.appendChild(leyendaColor);
                leyendaItem.appendChild(leyendaTexto);
                leyendaContainer.appendChild(leyendaItem);
                
                // Evento para resaltar al pasar el ratón
                leyendaItem.addEventListener('mouseover', () => {
                    resaltarSegmento(index);
                });
                
                // Evento para restaurar al quitar el ratón
                leyendaItem.addEventListener('mouseout', () => {
                    dibujarGrafico();
                    tooltip.style.opacity = 0;
                });
            });
        }

        // Función para resaltar un segmento
        function resaltarSegmento(index) {
            if (datos[index].valor <= 0) return;
            
            // Dibujar el gráfico base
            dibujarGrafico();
            
            // Calcular la posición del segmento
            const total = calcularTotal();
            const radio = (Math.min(canvas.width, canvas.height) / 2) - 10;
            const centroX = canvas.width / 2;
            const centroY = canvas.height / 2;
            const radioResaltado = radio * 1.05; // Ligeramente más grande
            
            let anguloInicial = -Math.PI / 2; // Comenzar desde arriba
            for (let i = 0; i < index; i++) {
                if (datos[i].valor > 0) {
                    anguloInicial += (datos[i].valor / total) * (Math.PI * 2);
                }
            }
            
            const angulo = (datos[index].valor / total) * (Math.PI * 2);
            const anguloFinal = anguloInicial + angulo;
            const anguloMedio = anguloInicial + (angulo / 2);
            
            // Redibujar el segmento resaltado
            ctx.beginPath();
            ctx.moveTo(centroX, centroY);
            ctx.arc(centroX, centroY, radioResaltado, anguloInicial, anguloFinal);
            ctx.closePath();
            
            ctx.fillStyle = datos[index].color;
            ctx.fill();
            ctx.lineWidth = 2;
            ctx.strokeStyle = 'white';
            ctx.stroke();
            
            // Mostrar tooltip
            const tooltipX = centroX + (radio * 0.75) * Math.cos(anguloMedio);
            const tooltipY = centroY + (radio * 0.75) * Math.sin(anguloMedio);
            
            tooltip.style.left = `${tooltipX}px`;
            tooltip.style.top = `${tooltipY}px`;
            tooltip.textContent = `${datos[index].nombre}: ${datos[index].valor} (${Math.round((datos[index].valor / total) * 100)}%)`;
            tooltip.style.opacity = 1;
        }
        
        // Actualizar el gráfico
        function actualizarGrafico() {
            dibujarGrafico();
            crearLeyenda();
        }
        
        // Inicializar el gráfico
        actualizarGrafico();
    </script>

    <!-- Am5 gauge charts -->
    <script>
        // Am5 chart objects
        let voltageGauge = null;
        let currentGauge = null;

        function createGaugeChart(chartId, color) {
            var root = am5.Root.new(chartId);
            root._logo.dispose();
            root.setThemes([
                am5themes_Animated.new(root)
            ]);
            
            var chart = root.container.children.push(
                am5radar.RadarChart.new(root, {
                    panX: false,
                    panY: false,
                    startAngle: 180,
                    endAngle: 360
                })
            );
            
            var axisRenderer = am5radar.AxisRendererCircular.new(root, {
                innerRadius: -10,
                strokeOpacity: 1,
                strokeWidth: 25,
                strokeGradient: am5.LinearGradient.new(root, {
                    rotation: 0,
                    stops: [
                        { color: am5.color(0x19d228) },
                        { color: am5.color(0xf4fb16) },
                        { color: am5.color(0xf6d32b) },
                        { color: am5.color(0xfb7116) }
                    ]
                })
            });
            
            var xAxis = chart.xAxes.push(
                am5xy.ValueAxis.new(root, {
                    maxDeviation: 0,
                    min: 0,
                    max: 100,
                    strictMinMax: true,
                    renderer: axisRenderer
                })
            );
            
            var axisDataItem = xAxis.makeDataItem({});
            axisDataItem.set("value", 0);
            
            var bullet = axisDataItem.set("bullet", am5xy.AxisBullet.new(root, {
                sprite: am5radar.ClockHand.new(root, {
                    radius: am5.percent(99)
                })
            }));
            
            xAxis.createAxisRange(axisDataItem);
            axisDataItem.get("grid").set("visible", false);
            
            chart.appear(1000, 100);
            
            return {
                chart: chart,
                axisDataItem: axisDataItem,
                root: root
            };
        }

        function updateGaugeValue(gauge, value) {
            if (!gauge) return;
            
            // Ensure value is between 0-100
            value = Math.min(Math.max(value, 0), 100);
            
            gauge.axisDataItem.animate({
                key: "value",
                to: value,
                duration: 800,
                easing: am5.ease.out(am5.ease.cubic)
            });
        }

        am5.ready(function() {
            // Create the gauge charts
            voltageGauge = createGaugeChart("chartdiv1");
            currentGauge = createGaugeChart("chartdiv2");
            
            // Set initial values based on data-attributes if available
            const initialVoltage = parseFloat(document.getElementById("chartdiv1").getAttribute("data-value") || "0");
            const initialCurrent = parseFloat(document.getElementById("chartdiv2").getAttribute("data-value") || "0");
            
            // Set initial values
            updateGaugeValue(voltageGauge, initialVoltage);
            updateGaugeValue(currentGauge, initialCurrent);
        });

        // Function to update gauges with new data
        function updateGauges(data) {
            // If we have voltage stats, calculate percentage based on max voltage
            if (data.voltage_stats && data.voltage_stats.max > 0) {
                const voltageMax = data.voltage_stats.max;
                const voltageValue = (data.latest.voltaje / voltageMax) * 100;
                updateGaugeValue(voltageGauge, voltageValue);
            }
            
            // If we have current stats, calculate percentage based on max current
            if (data.current_stats && data.current_stats.max > 0) {
                const currentMax = data.current_stats.max;
                const currentValue = (data.latest.corriente / currentMax) * 100;
                updateGaugeValue(currentGauge, currentValue);
            }
        }
    </script>

    <!-- Real-time updates script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get appliance ID from the data attribute or URL
            const applianceId = "1836ce95af11db705b9d3602";     
            
            const lastUpdateTime = document.getElementById('last-update-time');
            const refreshIndicator = document.getElementById('refresh-indicator');
            
            if (!applianceId) {
                console.error('Appliance ID not found');
                return;
            }
            
            // Function to format date and time
            function formatDateTime(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString('es-ES', {
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
            
            // Function to update UI with new data
            function updateUI(data) {
                // Update last update time
                lastUpdateTime.textContent = `Última actualización: ${new Date().toLocaleTimeString('es-ES')}`;
                
                // Update voltage display
                document.getElementById('voltaje-v').textContent = `${data.latest.voltaje.toFixed(1)}V`;
                document.getElementById('voltaje-date').textContent = formatDateTime(data.latest.fecha);
                
                // Update amperage display
                document.getElementById('amperios-a').innerHTML = `${data.latest.corriente.toFixed(1)} <span>A</span>`;
                document.getElementById('amperios-date').textContent = formatDateTime(data.latest.fecha);
                
                // Update power display (watts)
                const powerElement = document.querySelector('.corriente #amperios-a');
                if (powerElement) {
                    powerElement.innerHTML = `${data.latest.potencia.toFixed(0)} <span>W</span>`;
                }
                
                // Update consumption (kWh)
                const kwhElement = document.getElementById('kw');
                if (kwhElement) {
                    kwhElement.innerHTML = `${data.latest.consumo.toFixed(1)} <span>kWh</span>`;
                }
                
                // Update the second kWh display if it exists
                const secondKwhElement = document.querySelector('.dashboard2 h1');
                if (secondKwhElement) {
                    secondKwhElement.textContent = `${data.latest.consumo.toFixed(1)}kWh`;
                }
                
                // Update date under the second kWh display
                const secondDateElement = document.querySelector('.dashboard2 h3');
                if (secondDateElement) {
                    secondDateElement.textContent = formatDateTime(data.latest.fecha);
                }
                
                // Update chart data
                updateChart(data.daily_consumption);
                
                // Update stats displays
                if (data.voltage_stats.avg > 0) {
                    document.getElementById('voltaje-porcentaje').textContent = `${data.voltage_stats.avg.toFixed(0)}% promedio`;
                }
                
                // Update all instances of amperios-porcentaje
                const amperiosPorcentajeElements = document.querySelectorAll('#amperios-porcentaje');
                if (data.current_stats.avg > 0) {
                    amperiosPorcentajeElements.forEach(element => {
                        element.textContent = `${data.current_stats.avg.toFixed(0)}% promedio`;
                    });
                }
                
                // Update consumption history table
                updateHistoryTable(data.history);
                
                // Update gauge charts
                updateGauges(data);
            }
            
            // Function to update the consumption history table
            function updateHistoryTable(history) {
                const tableBody = document.querySelector('#dispositivo-table tbody');
                if (!tableBody) return;
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                // Add new rows
                history.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const [date, time] = item.fecha.split(' ');
                    
                    row.innerHTML = `
                        <td>#${item.id}</td>
                        <td>${date}<br>${time}</td>
                        <td>${item.voltaje.toFixed(1)} v</td>
                        <td>${item.corriente.toFixed(1)} A</td>
                        <td>${item.potencia.toFixed(0)} w</td>
                        <td>${item.consumo.toFixed(1)} kWh</td>
                        <td>${item.frecuencia.toFixed(0)}Hz</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
            }
            
            // Function to fetch the latest data
            function fetchLatestData() {
                // Show loading indicator
                refreshIndicator.classList.add('active');
                
                fetch(`/api/consumption/latest/${applianceId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            updateUI(data);
                        } else {
                            console.error('Error fetching data:', data.message);
                        }
                        
                        // Hide loading indicator after a short delay
                        setTimeout(() => {
                            refreshIndicator.classList.remove('active');
                        }, 500);
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                        
                        // Hide loading indicator
                        refreshIndicator.classList.remove('active');
                    });
            }
            
            // Fetch data immediately
            fetchLatestData();
            
            // Set up interval to fetch data every 5 seconds
            const updateInterval = setInterval(fetchLatestData, 5000);
            
            // Clean up interval when page is unloaded
            window.addEventListener('beforeunload', () => {
                clearInterval(updateInterval);
            });
        });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener el ID del aparato de la URL o del cuerpo de la página
        const applianceId = document.body.getAttribute('data-appliance-id');
        
        // Configurar el intervalo de actualización (cada 5 segundos)
        const UPDATE_INTERVAL = 5000;
        let lastUpdateTime = Date.now();
        
        // Función para actualizar las alertas
        function updateAlerts() {
            fetch(`/api/consumption/latest/${applianceId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.alerts && data.alerts.length > 0) {
                        // Actualizar la última hora de actualización
                        document.getElementById('last-update-time').textContent = 
                            `Última actualización: ${new Date().toLocaleTimeString()}`;
                        
                        // Borrar el mensaje de "no hay alertas" si existe
                        const noAlertsMsg = document.getElementById('no-alerts-message');
                        if (noAlertsMsg) {
                            noAlertsMsg.remove();
                        }
                        
                        // Contenedor de alertas
                        const alertsContainer = document.getElementById('alertas-container');
                        
                        // Añadir nuevas alertas que no estén ya en la página
                        data.alerts.forEach(alert => {
                            // Comprobar si la alerta ya existe en la página
                            if (!document.querySelector(`.alert-item[data-alert-id="${alert.id}"]`)) {
                                // Crear nueva alerta
                                const alertItem = document.createElement('div');
                                alertItem.className = 'alert-item';
                                alertItem.setAttribute('data-alert-id', alert.id);
                                
                                // Icono
                                const alertIcon = document.createElement('div');
                                alertIcon.className = 'alert-icon';
                                alertIcon.innerHTML = '<img src="https://i.imgur.com/j3d5GBP.png" alt="">';
                                alertItem.appendChild(alertIcon);
                                
                                // Mensaje
                                const alertMessage = document.createElement('div');
                                alertMessage.id = 'alert-alarm';
                                alertMessage.textContent = alert.mensaje || alert;
                                alertItem.appendChild(alertMessage);
                                
                                // Botón de cerrar
                                const closeBtn = document.createElement('div');
                                closeBtn.className = 'close-btn';
                                closeBtn.textContent = '✕';
                                closeBtn.addEventListener('click', function() {
                                    markAlertAttended(alert.id, alertItem);
                                });
                                alertItem.appendChild(closeBtn);
                                
                                // Añadir al contenedor con efecto de aparición
                                alertItem.style.opacity = '0';
                                alertsContainer.prepend(alertItem); // Añadir al principio
                                
                                // Animar la aparición
                                setTimeout(() => {
                                    alertItem.style.transition = 'opacity 0.5s ease';
                                    alertItem.style.opacity = '1';
                                }, 10);
                            }
                        });
                    } else if (document.querySelectorAll('.alert-item').length === 0) {
                        // Si no hay alertas y no hay elementos en la página, mostrar mensaje
                        const alertsContainer = document.getElementById('alertas-container');
                        
                        alertsContainer.innerHTML = `
                            <div class="alert-item" id="no-alerts-message">
                                <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                                <div id="alert-alarm">No hay alertas activas en este momento.</div>
                            </div>
                        `;
                    }
                })
                .catch(error => console.error('Error al actualizar alertas:', error));
        }
        
        // Función para marcar una alerta como atendida
        function markAlertAttended(alertId, alertElement) {
            // Mostrar efecto de "cargando" en el elemento
            alertElement.style.opacity = '0.5';
            
            fetch(`/api/alerts/attend/${alertId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Animar la desaparición de la alerta
                    alertElement.style.transition = 'all 0.5s ease';
                    alertElement.style.height = '0';
                    alertElement.style.opacity = '0';
                    alertElement.style.margin = '0';
                    alertElement.style.padding = '0';
                    
                    // Eliminar el elemento después de la animación
                    setTimeout(() => {
                        alertElement.remove();
                        
                        // Si no quedan alertas, mostrar el mensaje
                        if (document.querySelectorAll('.alert-item').length === 0) {
                            const alertsContainer = document.getElementById('alertas-container');
                            
                            alertsContainer.innerHTML = `
                                <div class="alert-item" id="no-alerts-message">
                                    <div class="alert-icon"><img src="https://i.imgur.com/j3d5GBP.png" alt=""></div>
                                    <div id="alert-alarm">No hay alertas activas en este momento.</div>
                                </div>
                            `;
                        }
                    }, 500);
                } else {
                    // Restaurar la opacidad si hay error
                    alertElement.style.opacity = '1';
                    console.error('Error al marcar alerta como atendida:', data.message);
                }
            })
            .catch(error => {
                // Restaurar la opacidad si hay error
                alertElement.style.opacity = '1';
                console.error('Error en la petición:', error);
            });
        }
        
        // Obtener valor de cookie (para CSRF token)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Configurar los botones de cerrar existentes
        document.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const alertItem = this.closest('.alert-item');
                const alertId = alertItem.getAttribute('data-alert-id');
                
                // Si tiene ID, es una alerta real
                if (alertId) {
                    markAlertAttended(alertId, alertItem);
                } else {
                    // Si no tiene ID, solo eliminar del DOM
                    alertItem.remove();
                }
            });
        });
        
        // Iniciar actualización periódica
        updateAlerts(); // Primera llamada inmediata
        setInterval(updateAlerts, UPDATE_INTERVAL);
    });
</script>
</body>
</html>